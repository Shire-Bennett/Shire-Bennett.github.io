<script type="module">
  import {
    initializeApp
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import {
    getFirestore,
    collection,
    addDoc,
    onSnapshot,
    query,
    orderBy,
    getDocs,
    deleteDoc,
    doc,
    writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDkH9bD2OWaI08cJVsdRNVU_XavoUTwIUA",
    authDomain: "shire-rats.firebaseapp.com",
    projectId: "shire-rats",
    storageBucket: "shire-rats.appspot.com",
    messagingSenderId: "541361661882",
    appId: "1:541361661882:web:8876816bc3cb591eb99f83"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const messagesRef = collection(db, "messages");

  const form = document.getElementById("messageForm");
  const input = document.getElementById("messageInput");
  const list = document.getElementById("messageList");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (input.value.trim() !== "") {
      await addDoc(messagesRef, {
        text: input.value,
        timestamp: Date.now()
      });
      input.value = "";
    }
  });

  const q = query(messagesRef, orderBy("timestamp", "desc"));
  onSnapshot(q, (snapshot) => {
    list.innerHTML = "";
    snapshot.forEach((doc) => {
      const li = document.createElement("li");
      li.textContent = doc.data().text;
      li.className = "message";
      list.appendChild(li);
    });
  });

  const clearBtn = document.getElementById("clearMessagesBtn");
  clearBtn.addEventListener("click", async () => {
    if (confirm("Are you sure you want to clear all messages?")) {
      const snapshot = await getDocs(messagesRef);
      const batch = writeBatch(db);

      snapshot.forEach((docItem) => {
        batch.delete(doc(db, "messages", docItem.id));
      });

      await batch.commit();
      console.log("All messages cleared.");
    }
  });
</script>
